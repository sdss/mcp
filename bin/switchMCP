#!/usr/bin/env bash

#DEBUG=0
#set -x

if [ $# != 4 ] ; then
    echo "Usage: switchMCP <mcp_version> <mcp_fiducials_version> <murmur_client_vx_version> <vx_tools_version>" >&2
    exit 1
fi

if [ `whoami` != "vxworks" ]; then
    echo "Run this script as the vxworks user." >&2
    exit 1
fi

MCP_DIR=../mcp/$1
MCP_FIDUCIALS_DIR=../mcp_fiducials/$2
MCPBASE_DIR=$HOME/mcpbase

MURMUR_CLIENT_VX_DIR=../murmur_client_vx/$3
VX_TOOLS_DIR=../vx_tools/$4

umask 002

if [ ! -d $MCPBASE_DIR ]; then
    echo "Directory $MCPBASE_DIR doesn't exist" >&2
    exit 1
fi

# Go to the mcpbase dir

cd $MCPBASE_DIR

# Make the links for the MCP package directories

for dir in ab bin doc etc ip src mei-src util; do
    [ -L $dir ] && rm $dir

    if [ $dir = fiducial-tables -a -d "$MCP_FIDUCIALS_DIR" ]; then
	ln -s $MCP_FIDUCIALS_DIR $dir
    elif [ -d $MCP_DIR/$dir ]; then
        ln -s $MCP_DIR/$dir $dir
    fi
    [ $DEBUG ] && ls -l $dir
done

# And for other required packages

for dir in MURMUR_CLIENT_VX VX_TOOLS; do
    ldir=`echo $dir | tr '[A-Z]' '[a-z]'`
    if [ X`eval echo \$''${dir}_DIR` = X"" ]; then
	"Please install $ldir and try again" >&2
	exit 1
    fi

    [ -L $ldir ] && rm $ldir

    eval ln -s \$''${dir}_DIR $ldir
    [ $DEBUG ] && ls -l $ldir
done

# And for fiducial tables

ldir=fiducial-tables
[ -L $ldir ] && rm $ldir
[ -d "$MCP_FIDUCIALS_DIR" ] && ln -s $MCP_FIDUCIALS_DIR $ldir
[ $DEBUG ] && ls -l $ldir

# Finally show the new MCP version

$MCP_DIR/bin/showMCP

exit 0
