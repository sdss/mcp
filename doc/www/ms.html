<HTML>
<TITLE>MCP Fiducials Commands</TITLE>
<H1>MCP Fiducials Commands</H1>

The MCP keeps two values for each fiducial on each axis; the `correct'
value, and the value of the encoder the last time that the fiducial
was crossed.  The `correct' values are kept in non-volatile shared
memory on the MCP, and may be loaded from files on the unix host.

<UL>
<LI> <A HREF="#overview">Overview of Fiducials</A>
<LI> <A HREF="#commands">`MS' Commands</A>
<LI> <A HREF="#logfiles">Fiducial Log Files</A>
<LI> <A HREF="#iopCommands">IOP Commands to Manipulate mcpFiducial Files</A>
</UL>

<H2><A NAME="overview">Overview of Fiducials</H2>

When an axis crosses a fiducial mark, two things happen in hardware:
<NL>
<LI> A signal is sent to the MEI to <EM>latch</EM> all the axes, i.e.
read the positions of all the encoders (two per axis).  The MEI
remembers these positions until they've been read and the board
is explicitly reset.

<LI> The systran DIO316 board in the MCP VME crate is told to generate
an interrupt for the MCP, telling it which axes were crossed.  This
interrupt is then disabled for <EM>all</EM> axes. A message is then
sent to the tLatch MCP task telling it which axes have seen a
fiducial crossing.  tLatch then decides which fiducial is crossed;
for the rotator this is easy as the distance between any two consecutive
marks on the optical tape identifies the fiducial.  For the azimuth
the MCP reads a barcode; for altitude it uses the clinometer.  Note
that this identification in azimuth and altitude is carried out
when the interrupt is <EMPH>recieved</EMPH>, not when the fiducial
is crossed.
</NL>

When the tLatch task receives the message it reads the position of
the indicated axes, then resets the MEI and reenables interrupts.
<P>

A consequence of this architecture is that while a fiducial crossing
is being processed on one axis, fiducial crossings on the other axes
are ignored.  This is unfortunate but necessary --- the MEI is unable
to latch the different axes separately, so the MCP is unable to read
the position of the second fiducial.  It would be possible to generate a
warning, but doing so would significantly complicate the code.

<H2><A NAME="commands">`MS' Commands</A></H2>

All fiducial commands start <CODE>MS.</CODE>; this stands for
MagnetoSensor, and reflects this history of the APO 3.5m.
<P>

The full command set is as follows; only <CODE>MS.ON</CODE>
and <CODE>MS.OFF</CODE> are generated by the TCC; for
a discussion see documentation of
<A HREF="http://www.apo.nmsu.edu/Telescopes/HardwareControllers/AxisCommands.html">Axis Controller commands</A>

<DL>
<DT> <A HREF="#correct_cmd">CORRECT</A>
<DD> Apply an arbitrarily large correction to an axis.

<DT> <A HREF="#ms_map_dump_cmd">MS.MAP.DUMP</A>
<DD> Not implemented; see <A HREF=#ms_write_cmd><CODE>MS.WRITE</A></CODE>.

<DT> <A HREF="#ms_map_load_cmd">MS.MAP.LOAD</A>
<DD> Not implemented; see <A HREF=#ms_read_cmd><CODE>MS.READ</A></CODE>.

<DT> <A HREF="#ms_off_cmd">MS.OFF</A>
<DD> Stop correcting an axis's position; the opposite of
<A HREF="#ms_on_cmd"><CODE>MS.ON</CODE></A>.

<DT> <A HREF="#ms_on_cmd">MS.ON</A>
<DD> Start correcting an axis's position; the opposite of
<A HREF="#ms_off_cmd"><CODE>MS.OFF</CODE></A>.

<DT> <A HREF="#ms_max_cmd">MS.MAX</A>
<DD> Set the maximum correction that
<A HREF="#ms_on_cmd"><CODE>MS.ON</CODE></A> is allowed to apply

<DT> <A HREF="#ms_read_cmd">MS.READ</A>
<DD> Read the `current' fiducial positions from a file on the unix host.

<DT> <A HREF="#ms_save_cmd">MS.SAVE</A>
<DD> Save the `correct' values of the fiducials to shared memory.

<DT> <A HREF="#ms_set_axis_pos_cmd">MS.SET</A>
<DD> Equivalent to <A HREF="#ms_set_axis_pos_cmd">SET.FIDUCIAL</A>

<DT> <A HREF="#ms_get_cmd">MS.GET</A>
<DD> Set the `current' values of the fiducials from the `correct' ones.

<DT> <A HREF="#ms_define_cmd">MS.DEFINE</A>
<DD> Set the `correct' fiducials array from the `current' fiducials.

<DT> <A HREF="#ms_write_cmd">MS.WRITE</A>
<DD> Write the `current' fiducials to a file.

<DT> <A HREF="#ms_set_axis_pos_cmd">SET.FIDUCIAL</A>
<DD> Tell the MEI where an axis is.
</DL>


<H3><A NAME="correct_cmd">CORRECT</A></H3>
<CODE>CORRECT</CODE> is equivalent to a <CODE>MS.ON</CODE>/<CODE>MS.OFF</CODE>
pair of commands, with the exception that an arbitrarily large correction
is allowed.

<H3><A NAME="ms_map_dump_cmd">MS.MAP.DUMP</A></H3>
Not implemented; see <A HREF=#ms_write_cmd><CODE>MS.WRITE</A></CODE>.

<H3><A NAME="ms_map_load_cmd">MS.MAP.LOAD</A></H3>
Not implemented; see <A HREF=#ms_read_cmd><CODE>MS.READ</A></CODE>.

<H3><A NAME="ms_off_cmd">MS.OFF</A> [DT]</H3>
Turn off <CODE>MS.ON</CODE>, that is, stop updating the encoders
every time that a fiducial is crossed.  If the time delay <CODE>dt</CODE>
is specified, only disable updates after <CODE>dt</CODE> seconds.

<H3><A NAME="ms_on_cmd">MS.ON</A></H3>
After an <CODE>MS.ON</CODE> command is received for a given axis,
and until a <CODE>MS.OFF</CODE> is seen (or takes effect if a delay is
specified), the encoders for that axis are corrected each time that
a fiducial is crossed.
<P>

More precisely, the MCP maintains a table of the `true' position
of each fiducial, and notes the difference between this position
and the encoder reading each time a fiducial is crossed; when
requested <CODE>MS.ON</CODE> is active, the encoder is adjusted
to make this error zero. It would
be possible to use the history of errors for a given axis to
estimate the error, but at present this is not done.
<P>

A <CODE>SET_FIDUCIAL_ERROR</CODE> entry is written the the
<CODE>mcpFiducials-mjd.dat</CODE> file every time that the encoders
are updated.
<P>

Because the MEI supports no atomic `update this axis' command, the
correction is applied in software; all positions that are sent to
or received from the MEI are corrected by the appropriate amount. Only
when the axis is given an <CODE>INIT</CODE> command is the encoder
actually updated.
<P>

<H3><A NAME="ms_max_cmd">MS.MAX</A> max</H3>

Set the maximum correction that <CODE>MS.ON</CODE> can make to
<CODE>max</CODE>. If a larger correction is requested an error message
is written to murmur (unless <CODE>max</CODE> is zero), and the
correction is <EM>not</EM> applied.  Furthermore, no further corrections are
permitted for that axis until after an <CODE>INIT</CODE>, and the
<CODE>ms_on_correction_too_large</CODE> bit is set in the axis status
word.
<P>

You should use the <CODE>CORRECT</CODE> command to apply arbitrarily
large corrections to an axis.

<H3><A NAME="ms_read_cmd">MS.READ</A> file</H3>
Read the positions of the fiducials from <CODE>file</CODE>,
as if they had just been crossed.
<P>

Note that this doesn't make them the `correct' values; to do that
you must use the <A HREF=#ms_define_cmd><CODE>MS.DEFINE</A></CODE>.
<P>

Any lines starting <CODE>#</CODE> are comments and are ignored, with
the exception of a line that looks like
<CODE># type fiducials</CODE>; <CODE>type</CODE> may be
<CODE>azimuth</CODE>, <CODE>altitude</CODE>, or <CODE>rotator</CODE>.
If this line is seen, the axis type <EM>must</EM> agree with the
current axis.
<P>
Data lines are of the form
<PRE>
  7           0 +- -9999.000000 0
  8   100167224 +- 0.000000 1
</PRE>
where the first integer is the fiducial index; the next the encoder
value for that fiducial, followed by its error; and finally the number of
points that were averaged together to derive the value.  Only the
first two values are used, except that the special error value
<CODE>-9999</CODE> is used to label a missing value.
<P>

When you switch to a new version of the MCP (using <CODE>switchMCP</CODE>)
the fiducial tables in the new version are installed in
<CODE>/p/mcpbase</CODE>; they are downloaded to the MCP itself at boot time.

<H3><A NAME="ms_save_cmd">MS.SAVE</A></H3>
Save the `correct' values of the fiducials to shared memory.
No human is likely to ever need to do this.

<H3><A NAME="ms_get_cmd">MS.GET</A></H3>
Set the `current' values of the fiducials from the `correct' ones.
Why would you ever want to do that? So as to be able to write them
to a file with <A HREF=#ms_write_cmd><CODE>MS.WRITE</A></CODE>.

<H3><A NAME="ms_define_cmd">MS.DEFINE</A></H3>
Set the `correct' fiducials array from the `current' fiducials. The
`current' fiducials may be read from a file using 
<A HREF=#ms_read_cmd><CODE>MS.READ</A></CODE>.

<H3><A NAME="ms_write_cmd">MS.WRITE</A> file</H3>
Write the `current' fiducial positions to <CODE>file</CODE>.
<P>

The format is:
<PRE>
#
# rotator fiducials
# ?????
#
# Fiducial Mark +- error  npoint
#
...
  7           0 +- -9999.000000 0
  8   100167224 +- 0.000000 1
...
</PRE>
An error of <CODE>-9999</CODE> is used to indicate that a value is missing.

<H3><A NAME="ms_set_axis_pos_cmd">SET.FIDUCIAL</A></H3>

Update the MEI's idea of the position of a given axis by the MCP's
current value for the error on that axis; the
MCP's software error is set to zero.
<P>

A <CODE>SET_FIDUCIAL_ERROR</CODE> entry is written the the
<CODE>mcpFiducials-mjd.dat</CODE> file every time that the encoders
are updated.

<H2><A NAME="logfiles">Fiducial Log Files</A></H2>

Most actions connected with the fiducial system are logged to a Yanny
`Parameter'-format file in <CODE>/mcptpm/mjd/mcpFiducials-mjd.dat</CODE>
where
<CODE>mjd</CODE> is the current SDSS-modified Modified Julian Day.
<P>

The <CODE>typedef</CODE>s in the file are:
<DL>

<DT> ALT_FIDUCIAL
<DD> An altitude fiducial has been crossed.
The fiducial index, its `correct' position, two encoder positions, the
velocity, and the raw clinometer reading are logged.

The clinometer reading may be decoded using:
<PRE>
	alt = 0.0048683116163*(8937 - clino)
</PRE>

<DT> AZ_FIDUCIAL
<DD>
The fiducial index, its `correct' position, and two encoder positions,
and the velocity are logged.

<DT> ROT_FIDUCIAL
<DD>
The fiducial index (negative if the index is one of the intermediate
dithered values), `correct' position, two encoder readings, velocity, and
the position of the previous fiducial crossed are logged.

<DT> DEFINE_FIDUCIALS
<DD> A <A HREF=#ms_define_cmd><CODE>MS.DEFINE</A></CODE> command has been
issued; which axis was affected is logged.

<DT> START_FIDUCIAL
<DD> The fiducials task in the MCP has restarted; this almost certainly
means that the MCP has been rebooted.

<DT> SET_FIDUCIAL
<DD> A <A HREF="#ms_set_axis_pos_cmd">SET.FIDUCIAL</A> command has been issued.
The axis, fiducial index, `correct' position, actual position, and
correction are logged.

<DT> UPDATE_ENCODER
<DD> The MEI's idea of the position of the axis has been reset, and the
MCP's software error cleared. The axis, current position, and applied
offset are logged.

<DT> SET_FIDUCIAL_ERROR
<DD> The MCP's idea of the encoder error in this axis has been updated. The
axis and new error are logged.

<DT> DISABLE_MS_CORRECTION
<DD> The TCC has requested the MCP to disable MS.ON updates to the encoder
positions as too large a correction (or too many large corrections) have
been requested. The time, axis, and offending correction are logged.

<DT> MS_ON
<DD> The TCC has sent the MCP an MS.ON command. The time and axis are logged.

<DT> MS_OFF
<DD> The TCC has sent the MCP an MS.OFF command. The time and axis are logged.

</DL>

<H2><A NAME="iopCommands">IOP Commands to Manipulate mcpFiducial Files</A></H2>

There are a number (well, one <EM>is</EM> a number) of commands in iop to
manipulate and analyse the mcpFiducials files that the MCP writes:

<DL>
<DT> plotMcpFiducials
<DD>
Read and analyze an mcpFiducials file
e.g.
<PRE>
 plotMcpFiducials -mjd 51799 \\
       -alt -y pos1 -x time -reset -canon -scale -table stdout
</PRE>

The file (by default the current one) is read, and the readings of
the specified encoder for the specified axis are analysed.
<P>

A complete list of options is available via <CODE>plotMcpFiducials -help</CODE>
<P>

If you specify <CODE>-x</CODE> and <CODE>-y</CODE> a plot of
<CODE>x</CODE> v. <CODE>y</CODE> is generated; useful choices for
<CODE>x</CODE> are <CODE>fididx</CODE> (fiducial index), <CODE>time</CODE>,
or <CODE>index</CODE>; you will usually want to use <CODE>pos1</CODE>
or <CODE>pos2</CODE> for <CODE>y</CODE>.  Unless you specify
<CODE>-absolute</CODE>, the value for each encoder will have a mean
value subtracted; exactly how that mean is determined is described in
the next paragraph.
<P>

If you specify <CODE>-x time</CODE> all the times will have a suitable
offset subtracted from them (it's given in the axis label).  If you
choose <CODE>-x index</CODE> the x-axis will be the rank
of the measurement's timestamps (i.e. the array index), starting at 0.

There are a number of flags to control how the mean value for each
fiducial is determined:
<DL>
<DT> -absolute
<DD>
Don't subtract any mean; use raw values

<DT> -canonical
<DD>
Adjust the value of the `canonical' fiducial to have the `canonical'
value; currently these are:
<BR>
<TABLE>
   <TR> <TD> Azimuth  <TD ALIGN=right> 33 <TD ALIGN=right> 31016188 </TR>
   <TR> <TD> Altitude <TD ALIGN=right>  1 <TD ALIGN=right>  3825222 </TR>
   <TR> <TD> Rotator  <TD ALIGN=right> 83 <TD ALIGN=right> 40168185 </TR>
</TABLE>

<DT> -error
<DD>
Use the position in the fiducial table as the `mean' value, so what's
plotted is the error relative to the fiducial table.  There's also an
option <CODE>-fiducialtable</CODE> to specify which fiducial table
should be used (e.g. <CODE>-error -fiducialtable /p/mcp/mcpVersion/%s.dat</CODE>,
where <CODE>%s</CODE> will be replaced by e.g. "rot";
<CODE>-fiducialtable mcpVersion</CODE> is also permitted) If you don't specify
a table the one current when the data was <EM>taken</EM> will be used.

<DT> -reset
<DD>
The middle encoder encountered in each sweep in the axis position is found
(averaged over sweeps), and matters are arranged so that that encoder has
the same value for every sweep; this is used to take out secular changes
(and is not needed for the instrument rotator).

<DT> -scale
<DD>

Estimate the scale (in arcsec/tick), and ensure that if an fiducial's
present in the table twice, once wrapped and once not, the two entries
always differ by the same amount (360*60*60/scale)
<P>

The value that -scale prints out is exactly the value that
should be in the file mcp/mcp-new/axis.h.
<P>


Implies the <CODE>-absolute</CODE> flag.

<DT> -time0 <t0>
<DD>
Discard all measurements taken before time t0.  If t0 is less than
the first time stamp in the file, it'll be interpreted as being
relative to the starting time subtracted from all times when they're
plotted (see above).

<DT> -time1 <t1>
<DD>
Discard all measurements taken after t1; see <CODE>-time0</CODE>
for the meaning of small values of t1.

<DT> -updown
<DD>
Analyse the encoder positions measured when the telescope was moving up and down
(or clockwise and anticlockwise) separately.  The mean `up' and `down'
values are then averaged together.

</DL>
<P>

Optionally, a fiducial table in the correct format for MS.READ can be
generated (using the <CODE>-table</CODE> flag).

<DT> mcpFiducialsPlots
<DD>
Make complete (?) sets of plots for a given axis, either to the screen
or to a set of files.

</DL>
</HTML>
