<HTML>
<TITLE>MCP Fiducials Commands</TITLE>
<H1>MCP Fiducials Commands</H1>

The MCP keeps two values for each fiducial on each axis; the `correct'
value, and the value of the encoder the last time that the fiducial
was crossed.  The `correct' values are kept in non-volatile shared
memory on the MCP, and may be loaded from files on the unix host.

<UL>
<LI> <A HREF="#commands">`MS' Commands</A>
<LI> <A HREF="#logfiles">Fiducial Log Files</A>
</UL>

<H2><A NAME="commands">`MS' Commands</A></H2>

All fiducial commands start <CODE>MS.</CODE>; this stands for
MagnetoSensor, and reflects this history of the APO 3.5m.
<P>

The full command set is as follows; only <CODE>MS.ON</CODE>
and <CODE>MS.OFF</CODE> are generated by the TCC.

<DL>
<DT> <A HREF="#correct_cmd">CORRECT</A>
<DD> Apply an arbitrarily large correction to an axis.

<DT> <A HREF="#ms_map_dump_cmd">MS.MAP.DUMP</A>
<DD> Not implemented; see <A HREF=#ms_write_cmd><CODE>MS.WRITE</A></CODE>.

<DT> <A HREF="#ms_map_load_cmd">MS.MAP.LOAD</A>
<DD> Not implemented; see <A HREF=#ms_read_cmd><CODE>MS.READ</A></CODE>.

<DT> <A HREF="#ms_off_cmd">MS.OFF</A>
<DD> Stop correcting an axis's position; the opposite of
<A HREF="#ms_on_cmd"><CODE>MS.ON</CODE></A>.

<DT> <A HREF="#ms_on_cmd">MS.ON</A>
<DD> Start correcting an axis's position; the opposite of
<A HREF="#ms_off_cmd"><CODE>MS.OFF</CODE></A>.

<DT> <A HREF="#ms_max_cmd">MS.MAX</A>
<DD> Set the maximum correction that
<A HREF="#ms_on_cmd"><CODE>MS.ON</CODE></A> is allowed to apply

<DT> <A HREF="#ms_read_cmd">MS.READ</A>
<DD> Read the `current' fiducial positions from a file on the unix host.

<DT> <A HREF="#ms_save_cmd">MS.SAVE</A>
<DD> Save the `correct' values of the fiducials to shared memory.

<DT> <A HREF="#ms_set_axis_pos_cmd">MS.SET</A>
<DD> Equivalent to <A HREF="#ms_set_axis_pos_cmd">SET.FIDUCIAL</A>

<DT> <A HREF="#ms_get_cmd">MS.GET</A>
<DD> Set the `current' values of the fiducials from the `correct' ones.

<DT> <A HREF="#ms_define_cmd">MS.DEFINE</A>
<DD> Set the `correct' fiducials array from the `current' fiducials.

<DT> <A HREF="#ms_write_cmd">MS.WRITE</A>
<DD> Write the `current' fiducials to a file.

<DT> <A HREF="#ms_set_axis_pos_cmd">SET.FIDUCIAL</A>
<DD> Tell the MEI where an axis is.
</DL>


<H3><A NAME="correct_cmd">CORRECT</A></H3>
<CODE>CORRECT</CODE> is equivalent to a <CODE>MS.ON</CODE>/<CODE>MS.OFF</CODE>
pair of commands, with the exception that an arbitrarily large correction
is allowed.

<H3><A NAME="ms_map_dump_cmd">MS.MAP.DUMP</A></H3>
Not implemented; see <A HREF=#ms_write_cmd><CODE>MS.WRITE</A></CODE>.

<H3><A NAME="ms_map_load_cmd">MS.MAP.LOAD</A></H3>
Not implemented; see <A HREF=#ms_read_cmd><CODE>MS.READ</A></CODE>.

<H3><A NAME="ms_off_cmd">MS.OFF</A> [DT]</H3>
Turn off <CODE>MS.ON</CODE>, that is, stop updating the encoders
every time that a fiducial is crossed.  If the time delay <CODE>dt</CODE>
is specified, only disable updates after <CODE>dt</CODE> seconds.

<H3><A NAME="ms_on_cmd">MS.ON</A></H3>
After an <CODE>MS.ON</CODE> command is received for a given axis,
and until a <CODE>MS.OFF</CODE> is seen (or takes effect if a delay is
specified), the encoders for that axis are corrected each time that
a fiducial is crossed.
<P>

More precisely, the MCP maintains a table of the `true' position
of each fiducial, and notes the difference between this position
and the encoder reading each time a fiducial is crossed; when
requested <CODE>MS.ON</CODE> is active, the encoder is adjusted
to make this error zero. It would
be possible to use the history of errors for a given axis to
estimate the error, but at present this is not done.
<P>

A <CODE>SET_FIDUCIAL_ERROR</CODE> entry is written the the
<CODE>mcpFiducials-mjd.dat</CODE> file every time that the encoders
are updated.
<P>

Because the MEI supports no atomic `update this axis' command, the
correction is applied in software; all positions that are sent to
or received from the MEI are corrected by the appropriate amount. Only
when the axis is given an <CODE>INIT</CODE> command is the encoder
actually updated.
<P>

<H3><A NAME="ms_max_cmd">MS.MAX</A> max</H3>

Set the maximum correction that <CODE>MS.ON</CODE> can make to
<CODE>max</CODE>. If a larger correction is requested an error message
is written to murmur (unless <CODE>max</CODE> is zero), and the
correction is <EM>not</EM> applied.  Furthermore, no further corrections are
permitted for that axis until after an <CODE>INIT</CODE>, and the
<CODE>ms_on_correction_too_large</CODE> bit is set in the axis status
word.
<P>

You should use the <CODE>CORRECT</CODE> command to apply arbitrarily
large corrections to an axis.

<H3><A NAME="ms_read_cmd">MS.READ</A> file</H3>
Read the positions of the fiducials from <CODE>file</CODE>,
as if they had just been crossed.
<P>

Note that this doesn't make them the `correct' values; to do that
you must use the <A HREF=#ms_define_cmd><CODE>MS.DEFINE</A></CODE>.
<P>

Any lines starting <CODE>#</CODE> are comments and are ignored, with
the exception of a line that looks like
<CODE># type fiducials</CODE>; <CODE>type</CODE> may be
<CODE>azimuth</CODE>, <CODE>altitude</CODE>, or <CODE>rotator</CODE>.
If this line is seen, the axis type <EM>must</EM> agree with the
current axis.
<P>
Data lines are of the form
<PRE>
  7           0 +- -9999.000000 0
  8   100167224 +- 0.000000 1
</PRE>
where the first integer is the fiducial index; the next the encoder
value for that fiducial, followed by its error; and finally the number of
points that were averaged together to derive the value.  Only the
first two values are used, except that the special error value
<CODE>-9999</CODE> is used to label a missing value.


<H3><A NAME="ms_save_cmd">MS.SAVE</A></H3>
Save the `correct' values of the fiducials to shared memory.
No human is likely to ever need to do this.

<H3><A NAME="ms_get_cmd">MS.GET</A></H3>
Set the `current' values of the fiducials from the `correct' ones.
Why would you ever want to do that? So as to be able to write them
to a file with <A HREF=#ms_write_cmd><CODE>MS.WRITE</A></CODE>.

<H3><A NAME="ms_define_cmd">MS.DEFINE</A></H3>
Set the `correct' fiducials array from the `current' fiducials. The
`current' fiducials may be read from a file using 
<A HREF=#ms_read_cmd><CODE>MS.READ</A></CODE>.

<H3><A NAME="ms_write_cmd">MS.WRITE</A> file</H3>
Write the `current' fiducial positions to <CODE>file</CODE>.
<P>

The format is:
<PRE>
#
# rotator fiducials
# ?????
#
# Fiducial Mark +- error  npoint
#
...
  7           0 +- -9999.000000 0
  8   100167224 +- 0.000000 1
...
</PRE>
An error of <CODE>-9999</CODE> is used to indicate that a value is missing.

<H3><A NAME="ms_set_axis_pos_cmd">SET.FIDUCIAL</A></H3>

Update the MEI's idea of the position of a given axis by the MCP's
current value for the error on that axis; the
MCP's software error is set to zero.
<P>

A <CODE>SET_FIDUCIAL_ERROR</CODE> entry is written the the
<CODE>mcpFiducials-mjd.dat</CODE> file every time that the encoders
are updated.

<H2><A NAME="logfiles">Fiducial Log Files</A></H2>

Most actions connected with the fiducial system are logged to a Yanny
`Parameter'-format file in <CODE>/mcptpm/mjd/mcpFiducials-mjd.dat</CODE>
where
<CODE>mjd</CODE> is the current SDSS-modified Modified Julian Day.
<P>

The <CODE>typedef</CODE>s in the file are:
<DL>

<DT> ALT_FIDUCIAL
<DD> An altitude fiducial has been crossed.
The fiducial index, its `correct' position, two encoder positions, and
the raw clinometer reading are logged.

The clinometer reading may be decoded using:
<PRE>
	alt = 0.0048683116163*(8937 - clino)
</PRE>

<DT> AZ_FIDUCIAL
<DD>
The fiducial index, its `correct' position, and two encoder positions
are logged.

<DT> ROT_FIDUCIAL
<DD>
The fiducial index (negative if the index is one of the intermediate
dithered values), `correct' position, two encoder readings, and
the position of the previous fiducial crossed are logged.

<DT> DEFINE_FIDUCIALS
<DD> A <A HREF=#ms_define_cmd><CODE>MS.DEFINE</A></CODE> command has been
issued; which axis was affected is logged.

<DT> START_FIDUCIAL
<DD> The fiducials task in the MCP has restarted; this almost certainly
means that the MCP has been rebooted.

<DT> SET_FIDUCIAL
<DD> A <A HREF="#ms_set_axis_pos_cmd">SET.FIDUCIAL</A> command has been issued.
The axis, fiducial index, `correct' position, actual position, and
correction are logged.

<DT> UPDATE_ENCODER
<DD> The MEI's idea of the position of the axis has been reset, and the
MCP's software error cleared. The axis, current position, and applied
offset are logged.

<DT> SET_FIDUCIAL_ERROR
<DD> The MCP's idea of the encoder error in this axis has been updated. The
axis and new error are logged.


</DL>

</HTML>
